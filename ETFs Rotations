import numpy as np
import pandas as pd
import math
import datetime
import requests
import json

def initialize(context):
    g.etf_pool = [
        '159915.XSHE',  
        '510180.XSHG',  
        '518880.XSHG',  
        '513100.XSHG',  
        '159509.XSHE',  
        '512100.XSHG',  
        '513500.XSHG',  
        '512480.XSHG'   
    ]
    g.m_days = 25      
    g.max_drawdown = 0.05      
    g.suspension_days = 10     
    g.suspended_etfs = {}      
    g.buy_price_dict = {}
    set_benchmark('000300.XSHG')
    set_slip_fee(context)
    run_daily(trade, time='9:31', reference_security='000300.XSHG')
    run_daily(check_risk, time='11:25', reference_security='000300.XSHG')
    run_daily(check_risk, time='14:45', reference_security='000300.XSHG')
    g.dingding_url = ""
    g.etf_names = {
        '159915.XSHE': 'åˆ›ä¸šæ¿ETF',
        '510180.XSHG': 'ä¸Šè¯180ETF',
        '518880.XSHG': 'é»„é‡‘ETF',
        '513100.XSHG': 'çº³æŒ‡ETF',
        '159509.XSHE': 'çº³æŒ‡ç§‘æŠ€ETF',
        '512100.XSHG': 'ä¸­è¯1000ETF',
        '513500.XSHG': 'æ ‡æ™®500ETF',
        '512480.XSHG': 'ç§‘åˆ›100ETF'
    }

def set_slip_fee(context):
    set_slippage(PriceRelatedSlippage(0.002))
    set_order_cost(OrderCost(
        open_tax=0,           
        close_tax=0.001,      
        open_commission=0.0003,
        close_commission=0.0003,
        min_commission=5),     
        type='stock')

def check_abnormal_volatility(etf):
    df = attribute_history(etf, 1, '1d', ['high', 'close'])
    today_high = df['high'].iloc[-1]
    today_close = df['close'].iloc[-1]
    today_drawdown = (today_high - today_close) / today_high
    return today_drawdown > g.max_drawdown

def check_risk(context):
    current_time = context.current_dt.strftime('%H:%M')
    time_mark = "ä¸Šåˆ" if current_time == "11:25" else "ä¸‹åˆ"
    hold_list = list(context.portfolio.positions)
    current_date = context.current_dt.date()
    risk_msg = f"ğŸ” {time_mark}é£æ§æ£€æŸ¥æŠ¥å‘Š\n"
    risk_msg += f"â° æ£€æŸ¥æ—¶é—´ï¼š{context.current_dt.strftime('%Y-%m-%d %H:%M')}\n"
    risk_msg += f"ğŸ’° å½“å‰å‡€å€¼ï¼š{context.portfolio.total_value:.2f}\n"
    risk_msg += f"ğŸ’µ å¯ç”¨èµ„é‡‘ï¼š{context.portfolio.available_cash:.2f}\n"
    risk_msg += "-" * 30 + "\n"
    if not hold_list:
        risk_msg += "ğŸ“¢ å½“å‰æ— æŒä»“ï¼Œè·³è¿‡é£æ§æ£€æŸ¥\n"
        send_dingding(risk_msg)
        return
    risk_msg += "ğŸ” æŒä»“æ£€æŸ¥ç»“æœï¼š\n"
    for etf in hold_list:
        df = attribute_history(etf, 1, '1d', ['high', 'low', 'open', 'close', 'volume'])
        today_high = df['high'].iloc[-1]
        today_low = df['low'].iloc[-1]
        today_open = df['open'].iloc[-1]
        today_close = df['close'].iloc[-1]
        today_drawdown = (today_high - today_close) / today_high
        position = context.portfolio.positions[etf]
        risk_msg += f"\nğŸ“Š {g.etf_names[etf]}({etf}):\n"
        risk_msg += f"  â€¢ æŒä»“æ•°é‡ï¼š{position.total_amount}è‚¡\n"
        risk_msg += f"  â€¢ æŒä»“æˆæœ¬ï¼š{position.avg_cost:.3f}\n"
        risk_msg += f"  â€¢ å½“å‰ä»·æ ¼ï¼š{today_close:.3f}\n"
        risk_msg += f"  â€¢ ä»Šæ—¥æŒ¯å¹…ï¼š{((today_high/today_low - 1) * 100):.2f}%\n"
        risk_msg += f"  â€¢ ä»Šæ—¥æ¶¨è·Œï¼š{((today_close/today_open - 1) * 100):.2f}%\n"
        risk_msg += f"  â€¢ å½“æ—¥å›æ’¤ï¼š{today_drawdown:.2%}\n"
        risk_msg += f"  â€¢ æŒä»“æ”¶ç›Šï¼š{((today_close/position.avg_cost - 1) * 100):.2f}%\n"
        if check_abnormal_volatility(etf):
            risk_msg += f"âš ï¸ è§¦å‘é£æ§ï¼š\n"
            risk_msg += f"  â€¢ å›æ’¤è¶…è¿‡é˜ˆå€¼ {g.max_drawdown:.2%}\n"
            risk_msg += f"  â€¢ æ‰§è¡Œå–å‡ºå¹¶æš‚åœ{g.suspension_days}å¤©\n"
            order_target_value(etf, 0)
            g.suspended_etfs[etf] = current_date + datetime.timedelta(days=g.suspension_days)
        else:
            risk_msg += "âœ… é€šè¿‡é£æ§æ£€æŸ¥\n"
        risk_msg += "-" * 20 + "\n"
    send_dingding(risk_msg)

def trade(context):
    log.info(f"\n=== {context.current_dt.date()} äº¤æ˜“ä¿¡å·æ£€æŸ¥ ===")
    current_date = context.current_dt.date()
    before_update = set(g.suspended_etfs.keys())
    g.suspended_etfs = {etf: date for etf, date in g.suspended_etfs.items() if date > current_date}
    removed = before_update - set(g.suspended_etfs.keys())
    if removed:
        log.info(f"è§£é™¤æš‚åœ: {removed}")
    if g.suspended_etfs:
        log.info(f"å½“å‰æš‚åœåˆ—è¡¨: {g.suspended_etfs}")
    target_num = 1    
    target_list = get_rank(g.etf_pool, context)[:target_num]
    log.info(f"ç›®æ ‡ETF: {target_list}")
    hold_list = list(context.portfolio.positions)
    log.info(f"å½“å‰æŒä»“: {hold_list}")
    for etf in hold_list:
        if etf not in target_list:
            order_target_value(etf, 0)
            log.info(f"å–å‡ºå†³ç­–: {etf} ä¸åœ¨ç›®æ ‡æ¸…å•ä¸­")
    hold_list = list(context.portfolio.positions)
    if len(hold_list) < target_num:
        value = context.portfolio.available_cash / (target_num - len(hold_list))
        log.info(f"å¯ç”¨ç°é‡‘: {context.portfolio.available_cash:.2f}, ç›®æ ‡ä¹°å…¥é‡‘é¢: {value:.2f}")
        for etf in target_list:
            if etf in g.suspended_etfs:
                log.info(f"ä¹°å…¥å†³ç­–: {etf} åœ¨æš‚åœæœŸè‡³{g.suspended_etfs[etf]}ï¼Œè·³è¿‡")
                continue
            if context.portfolio.positions[etf].total_amount == 0:
                order_target_value(etf, value)
                log.info(f"ä¹°å…¥å†³ç­–: æ‰§è¡Œä¹°å…¥ {etf}, é‡‘é¢{value:.2f}")
    log_portfolio(context)
    log.info("=== äº¤æ˜“æ£€æŸ¥ç»“æŸ ===\n")
    trade_msg = "ğŸ’¹ äº¤æ˜“ä¿¡å·æŠ¥å‘Š\n"
    trade_msg += f"â° äº¤æ˜“æ—¶é—´ï¼š{context.current_dt.strftime('%Y-%m-%d %H:%M')}\n"
    trade_msg += f"ğŸ’° è´¦æˆ·æ€»å€¼ï¼š{context.portfolio.total_value:.2f}\n"
    trade_msg += f"ğŸ’µ å¯ç”¨èµ„é‡‘ï¼š{context.portfolio.available_cash:.2f}\n"
    trade_msg += "-" * 30 + "\n"
    if removed:
        trade_msg += "ğŸ”“ è§£é™¤æš‚åœäº¤æ˜“ï¼š\n"
        for etf in removed:
            trade_msg += f"  â€¢ {g.etf_names[etf]}({etf})\n"
        trade_msg += "-" * 20 + "\n"
    sell_list = [etf for etf in hold_list if etf not in target_list]
    if sell_list:
        trade_msg += "ğŸ“‰ å–å‡ºå†³ç­–ï¼š\n"
        for etf in sell_list:
            position = context.portfolio.positions[etf]
            returns = (position.price/position.avg_cost - 1) * 100
